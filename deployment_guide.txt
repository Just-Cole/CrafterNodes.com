
# Ubuntu Server Deployment Guide for Next.js Application

This guide provides the necessary commands to deploy your Next.js application on a fresh Ubuntu server.

**Prerequisites:**
- An Ubuntu 22.04 server.
- A domain name pointing to your server's IP address.
- You are logged in as a user with sudo privileges.

# --------------------------------------------------
# Step 1: Update Server and Install Dependencies
# --------------------------------------------------

# Update package lists
sudo apt update && sudo apt upgrade -y

# Install Nginx (web server), Git (for pulling code), and UFW (firewall)
sudo apt install -y nginx git ufw

# --------------------------------------------------
# Step 2: Install Node.js and PM2
# --------------------------------------------------

# We will use NodeSource to install a modern version of Node.js (e.g., Node.js 20.x)
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs

# Verify installation
node -v
npm -v

# Install PM2, a process manager for Node.js applications.
# This will keep your app running forever and restart it if it crashes.
sudo npm install pm2 -g

# --------------------------------------------------
# Step 3: Install and Configure MariaDB
# --------------------------------------------------

# Install the MariaDB server package
sudo apt install -y mariadb-server

# Run the secure installation script.
# This will guide you through setting a root password, removing anonymous users,
# and other important security settings. This step is highly recommended.
sudo mysql_secure_installation

# Log in to MariaDB as the root user to set up your database.
# You will be prompted for the root password you created in the step above.
sudo mysql -u root -p

# --- Run the following commands inside the MariaDB prompt ---

# 1. Create a database for your application.
CREATE DATABASE crafternodes;

# 2. Create a dedicated user for your application.
#    Replace 'your_strong_password' with a secure password.
CREATE USER 'crafteruser'@'localhost' IDENTIFIED BY 'your_strong_password';

# 3. Grant the new user privileges on your application's database.
GRANT ALL PRIVILEGES ON crafternodes.* TO 'crafteruser'@'localhost';

# 4. Apply the changes.
FLUSH PRIVILEGES;

# 5. Exit the MariaDB prompt.
EXIT;

# --- End of MariaDB prompt commands ---

# Now, connect to your new database as the user you just created
# and run the table creation scripts below.
# You can do this from the command line:
# mysql -u crafteruser -p crafternodes
#
# Or you can connect using a GUI tool like HeidiSQL with the new user credentials.

# --- SQL Commands to create the necessary tables ---

CREATE TABLE `games` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(255) NOT NULL,
  `description` text NOT NULL,
  `image` varchar(255) NOT NULL,
  `hint` varchar(255) NOT NULL,
  `pterodactylNestId` int(11) NOT NULL,
  `pterodactylEggId` int(11) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

CREATE TABLE `plans` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `game_id` int(11) NOT NULL,
  `name` varchar(255) NOT NULL,
  `price` varchar(255) NOT NULL,
  `priceId` varchar(255) DEFAULT NULL,
  `features` longtext CHARACTER SET utf8mb4 COLLATE utf8mb4_bin NOT NULL CHECK (json_valid(`features`)),
  `icon` varchar(255) DEFAULT NULL,
  `popular` tinyint(1) DEFAULT 0,
  PRIMARY KEY (`id`),
  KEY `game_id` (`game_id`),
  CONSTRAINT `plans_ibfk_1` FOREIGN KEY (`game_id`) REFERENCES `games` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;


# --------------------------------------------------
# Step 4: Enabling Remote Database Access (for HeidiSQL)
# --------------------------------------------------

# By default, your database only allows connections from your VPS itself.
# To connect with a tool like HeidiSQL from your home computer, you must
# enable remote access.

# 1. Allow MariaDB to listen on all IP addresses.
#    Open the configuration file:
sudo nano /etc/mysql/mariadb.conf.d/50-server.cnf

#    Find the line that says `bind-address = 127.0.0.1` and put a `#`
#    at the beginning to comment it out. It should look like this:
#    #bind-address = 127.0.0.1
#    Save the file and exit (Ctrl+X, then Y, then Enter).

# 2. Grant privileges to your user for remote connections.
#    Log back into MariaDB:
sudo mysql -u root -p

#    Run the following command, replacing 'your_strong_password' with the
#    actual password for your 'crafteruser'.
GRANT ALL PRIVILEGES ON crafternodes.* TO 'crafteruser'@'%' IDENTIFIED BY 'your_strong_password';
FLUSH PRIVILEGES;
EXIT;

# 3. Restart MariaDB to apply the new configuration.
sudo systemctl restart mariadb


# --------------------------------------------------
# Step 5: Clone and Build Your Application
# --------------------------------------------------

# Clone your project from your Git repository
git clone https://github.com/Just-Cole/CrafterNodes.com.git
cd CrafterNodes.com

# Install project dependencies
npm install

# Build your Next.js app for production
npm run build

# Create a .env.local file for your production environment variables
# IMPORTANT: You must fill this file with your actual secrets.
cat > .env.local << EOF
# Database
# Use the credentials for the 'crafteruser' you created in Step 3.
# The format is: mysql://user:password@host:port/database
# Example: DATABASE_URL="mysql://crafteruser:your_strong_password@127.0.0.1:3306/crafternodes"
# NOTE: The host is 127.0.0.1 because the app is running on the same server as the database.
DATABASE_URL="your_database_connection_string"

# SteamGridDB
STEAMGRIDDB_API_KEY=your_steamgriddb_api_key

# Pterodactyl Environment Variables
PTERODACTYL_PANEL_URL=https://your.pterodactyl.panel
PTERODACTYL_API_KEY=your_pterodactyl_application_api_key

# Stripe Environment Variables
STRIPE_SECRET_KEY=your_stripe_secret_key
STRIPE_WEBHOOK_SECRET=your_stripe_webhook_secret
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=your_stripe_publishable_key

# NextAuth Environment Variables
NEXTAUTH_SECRET=generate_a_strong_secret_here # You can generate one with `openssl rand -base64 32`
NEXTAUTH_URL=https://your-domain.com

# Discord OAuth Environment Variables
DISCORD_CLIENT_ID=your_discord_client_id
DISCORD_CLIENT_SECRET=your_discord_client_secret
EOF

# --------------------------------------------------
# Step 6: Run the Application with PM2
# --------------------------------------------------

# Start the Next.js application using PM2.
# This will start the app on port 3000 by default.
pm2 start npm --name "next-app" -- start

# Tell PM2 to start on system boot
pm2 startup
# (You will need to run the command PM2 gives you here)

# Save the current process list
pm2 save

# --------------------------------------------------
# Step 7: Configure Nginx as a Reverse Proxy
# --------------------------------------------------

# Create a new Nginx configuration file for your site.
# Replace 'your-domain.com' with your actual domain name.
sudo nano /etc/nginx/sites-available/your-domain.com

# Paste the following configuration into the file.
# This tells Nginx to listen for traffic on port 80 and forward it
# to your Next.js app running on port 3000.
#
# Again, replace 'your-domain.com' with your actual domain.

<<'EOF'
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
EOF

# Enable the new configuration by creating a symbolic link
sudo ln -s /etc/nginx/sites-available/your-domain.com /etc/nginx/sites-enabled/

# Test the Nginx configuration for syntax errors
sudo nginx -t

# Restart Nginx to apply the changes
sudo systemctl restart nginx

# --------------------------------------------------
# Step 8: Configure Firewall
# --------------------------------------------------

# Allow OpenSSH
sudo ufw allow 'OpenSSH'

# Allow Nginx HTTP traffic
sudo ufw allow 'Nginx Full'

# Allow remote connections to MariaDB
sudo ufw allow 3306/tcp

# Enable the firewall
sudo ufw enable
# (Press 'y' to confirm)

# --------------------------------------------------
# Step 9: Secure Your Site with SSL (Let's Encrypt)
# --------------------------------------------------

# Install Certbot, the client for Let's Encrypt
sudo apt install -y certbot python3-certbot-nginx

# Obtain and install the SSL certificate.
# Certbot will automatically edit your Nginx configuration to handle HTTPS.
# Replace 'your-domain.com' with your domain.
sudo certbot --nginx -d your-domain.com -d www.your-domain.com

# Certbot will ask for your email and to agree to the terms of service.
# It will then automatically configure SSL.

# Your site should now be live and accessible via HTTPS!
# You can check the status of the certbot renewal timer with:
sudo systemctl status certbot.timer

# --------------------------------------------------
# Step 10: Updating Your Application
# --------------------------------------------------

# When you make changes to your application and push them to your GitHub repository,
# you'll need to pull those changes down to your server to make them live.

# First, connect to your server and navigate to your project directory:
cd ~/CrafterNodes.com

# Pull the latest changes from the 'main' branch (or whichever branch you use)
git pull

# Install any new dependencies that might have been added
npm install

# Re-build the application with the new changes
npm run build

# Restart the application using PM2 to apply the changes
pm2 restart next-app

# You can check the status of your application with:
pm2 status
